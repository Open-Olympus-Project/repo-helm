---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: az-base-template
spec:
  entrypoint: az-base
  arguments:
    parameters:
      - name: sp-secret-name
        value: service-principal
  templates:
  - name: az-base
    inputs:
      parameters:
      - name: script
      - name: sp-secret-name
        default: service-principal
    container:
      image: mcr.microsoft.com/azure-cli
      command: ["/bin/sh", "-c"]
      args:
        - |
          for f in /vault/secrets/*; do source $f; done;
          az login --service-principal -u $sp_client_id -p $sp_client_secret --tenant $sp_tenant_id --output none;
          az account set --subscription $sp_subscription_id

          {{`{{inputs.parameters.script}}`}}
      env:
        - name: ARM_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: '{{`{{inputs.parameters.sp-secret-name}}`}}-secret'
              key: clientid
        - name: ARM_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: '{{`{{inputs.parameters.sp-secret-name}}`}}-secret'
              key: clientsecret
        - name: ARM_SUBSCRIPTION_ID
          valueFrom:
            secretKeyRef:
              name: '{{`{{inputs.parameters.sp-secret-name}}`}}-secret'
              key: subscriptionid
        - name: ARM_TENANT_ID
          valueFrom:
            secretKeyRef:
              name: '{{`{{inputs.parameters.sp-secret-name}}`}}-secret'
              key: tenantid
